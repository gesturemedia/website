(()=>{"use strict";const t=[["product-form",".product-form__quantity"],['[data-pf-type="ProductATC"]','[data-pf-type="ProductQuantity"]'],[".product-form__item--submit",'label[for="Quantity-product-template"]'],[".product-single__add-to-cart",".product-single__quantity"],[".product-info__buy-buttons",".product-info__quantity-selector"],[".ProductForm__BuyButtons, .ProductForm__AddToCart",".ProductForm__QuantitySelector"],['[data-block-type="buy-buttons"]','[data-block-type="quantity-selector"]'],[".product-page--submit-action",".quantity-controls__outer"],[".product-form__payment-container",".product-form__info-item--quantity"],["[data-product-submit]",".product-quantity-input"],[".product-form--atc",".product-form--atc-qty"],[".purchase-details",".purchase-details__quantity"],[".product-single__form .payment-buttons",".product__quantity"],[".product-form--wide",".product-single__quantity"],[".product-single__add-to-cart",".product-single__quantity"],[".product-form--button-container",null],[".product-form__item--submit",".product-form__item--quantity"],[".product-detail__form__action",null],[".product__submit__buttons",null],[".buy-buttons-row",".quantity-wrapper"],[".t4s-product-form__buttons","[data-quantity-wrapper]"],[".qty-wrapper--with-payment-button",".product-qty"],[".shopify-product-form",".product-quantity-block"],[".shopify-product-form",".product-block-quantity-selector"],[".type_buy_buttons",".type_quantity_selector"],[".product-single__form .add-to-cart",".product__quantity"],[".purchase-section",".quantity.form"],[".product-form__buttons",".quantity_selector"],[".product__atc",".quantity--input"],[".product-form__payment-container",".quantity-selector"],['[data-icon="gpicon-product-cartbutton"]','[data-icon="gpicon-product-quantity"]'],["gp-product-button","gp-product-quantity"],[".ecom-product-single__add-to-cart",".ecom-product-single__quantity"],[".product-form__submit",".product__quantity"],[".product-info__add-to-cart","quantity-input"],[".yv-checkout-btn",".yv-product-quantity"],[".product-add-to-cart-container","quantity-selector"],[".product__block__buttons",".product__block__quantity"]],i=()=>new URLSearchParams(window.location.search).get("kaching");let n;let s;const o=()=>(void 0===s&&(s="debug"===i()),s);let e;const r=async(t,i,n)=>{const s=`https://${t||"kachingappz-bundles.herokuapp.com"}/storefront_api/${i}`,o={...n,shop:window.Shopify.shop,version:C()};return await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)})},a=async(t,i,n={})=>{const s=window.location.href;return await r(t,"events",{event:{name:i,data:n,url:s}})},c=async(t,i,n,s)=>{const o=window.location.href;return await r(t,"errors",{error:{filename:i,message:n,stack:s,url:o}})},u=t=>{const i=["kaching-bundles.js","kaching-bundles-block.js","kaching-cart.js"];window.addEventListener("error",(async function(n){try{await(async n=>{const{filename:s,message:e,error:r}=n;for(let a of i)if(s.includes(a)){if(o())return void d("Error",n);await c(t,s,e,r.stack)}})(n)}catch(t){console.error(t)}})),window.addEventListener("unhandledrejection",(async function(n){try{await(async n=>{if("object"!=typeof n.reason)return;const{message:s,stack:e}=n.reason;if(e)for(let r of i)if(e.includes(r)){if(o())return void d("Unhandled rejection",n);await c(t,r,s,e)}})(n)}catch(t){console.error(t)}}))};function d(t,n=null){(o()||(void 0===e&&(e="dev"===i()),e))&&console.debug("[Kaching Bundles]",t,n)}const h=()=>{const t=t=>{window.dispatchEvent(new Event(t))};let i=history.pushState;history.pushState=function(){let n=i.apply(this,arguments);return t("pushstate"),t("locationchange"),n};let n=history.replaceState;history.replaceState=function(){let i=n.apply(this,arguments);return t("replacestate"),t("locationchange"),i},_(window,"popstate",(()=>{t("locationchange")}))},l=(t,i,n,s=0)=>{let o=Object.getPrototypeOf(t);if(o.hasOwnProperty(i)){let e=Object.getOwnPropertyDescriptor(o,i);if(!e.configurable)return;Object.defineProperty(t,i,{configurable:!0,get:function(){return e.get.apply(this,arguments)},set:function(){let t=this[i];e.set.apply(this,arguments);let o=this[i];return"function"==typeof n&&setTimeout(n.bind(this,t,o),s),o}})}},p=(t,i=document)=>i.querySelector(t),f=(t,i=document)=>i.querySelectorAll(t),_=(t,i,n)=>t.addEventListener(i,n),m=t=>document.createElement(t),y=(t,i,n)=>t.setAttribute(i,n),b=t=>t.dataset,w=t=>{const i=p(t);if(!i)return;const n=JSON.parse(i.textContent);return d("jsonFromElement",n),n},g=(t,i)=>{let n=0,s=t;for(;s!==i&&s!==document.body;)n++,s=s.parentNode;if(s!==i)throw new Error("The specified child node is not a descendant of the parent node.");return n},k=(t,i)=>{let n=new Range;return n.setStart(t,0),n.setEnd(i,0),n.collapsed&&(n.setStart(i,0),n.setEnd(t,0)),n.commonAncestorContainer},v=(t,i,n=1/0)=>{let s=null,o=1/0;for(const e of i){const i=k(t,e),r=g(t,i);r>n||r<o&&(s=e,o=r)}return s},C=()=>{const t=document.currentScript&&document.currentScript.src;if(!t)return;const i=t.match(/\/([^/]+)\/assets\//);return i&&i[1]?i[1]:void 0},q=t=>{const i=window.Shopify.routes;return(i&&i.root||"/")+t};const I=class{constructor(t,i,n,s,o){d("AddToCartForm",[t]),this.t=t,this.i=i,this.o=n,this.u=s,this.h=o}update(t){if(d("AddToCartForm#update",[this.t,t]),1===t.length||this.u){const i=t.find((t=>t.variantId==this.currentVariantId()))||t[0],{variantId:n,quantity:s}=i;this.l({variantId:n,quantity:s})}else t.length>1&&this.p(t)}legacyFormData(){const t=new FormData(this.t);if(t.has("items[0][id]")&&(t.delete("id"),t.delete("quantity")),!t.get("items[0][id]")&&!t.get("id")){const t=document.querySelector('input[name="id"], select[name="id"]');a(this.h.customApiHost,"missing_id_input_v2",t&&{class:t.className,id:t.id,tag:t.tagName})}return t}currentVariantId(){const t=this._("id");if(t)return t.value;a(this.h.customApiHost,"missing_id_input_v3")}l(t){this.m();const{variantId:i,quantity:n}=t,s=this.g("id");s.disabled=!1,s.value=i,this.k(n)}k(t){d("AddToCartForm#_updateQuantityInput",t);let i=null;i=this.o?this.g("quantity"):this._("quantity"),i&&(i.disabled=!1,i.value=t)}p(t){this.m();for(const[i,n]of t.entries()){const{variantId:t,quantity:s}=n;this.g(`items[${i}][id]`).value=t;this.g(`items[${i}][quantity]`).value=s}this.v()}v(){const t=this._("id");t&&(t.disabled=!0);const i=this._("quantity");i&&(i.disabled=!0)}m(){const t=f('input[name^="items"]',this.t);for(const i of t)i.remove()}g(t){return this._(t)||this.C(t)}_(t){return p(`[name="${t}"]`,this.t)}C(t){const i=m("input");return i.type="hidden",i.name=t,this.t.prepend(i),i}},T=window;const S=class{constructor(t,i,n,s,o,e,r,a){d("DealBlock",{dealBlock:t,cartForm:i,addToCartButton:n,quantityInput:s,variantPicker:o,globalConfig:e,dealBlockConfig:r,product:a}),this.q=t,this.t=i,this.I=n,this.T=s,this.S=o,this.h=e,this.P=r,this.i=a,this.F=this.i.selectedVariantId||this.i.variants[0].id,this.V=i&&new I(i,a,!s,e.addDifferentVariantsToCartSeparately,e),this.A()}A(){y(this.q,"config",JSON.stringify(this.h)),y(this.q,"deal-block",JSON.stringify(this.P)),y(this.q,"product",JSON.stringify(this.i)),y(this.q,"current-variant-id",this.F),this.t&&this.I&&this.$()}$(){this.B(),this.O(),this.j(),this.N(),this.D(),this.M(),this.R(),this.h.addDifferentVariantsToCartSeparately?this.J():this.L()}B(){h(),_(T,"locationchange",(()=>{const t=new URLSearchParams(T.location.search).get("variant");t&&this.U(t)}))}O(){const t=p('input[name="id"]',this.t);t&&l(t,"value",((t,i)=>{d("_listenForVariantIdInputChange",[t,i]),t!==i&&i&&this.U(i)}))}j(){const t=p('select[name="id"]',this.t);if(!t)return;let i;window.setInterval((()=>{const n=t.value;i!==n&&n&&(d("_listenForVariantIdSelectChange",[i,n]),i=n,this.U(n))}),100)}U(t){if(t!=this.F&&(this.F=t,!this.H)){if(this.K(),d("handleNativeVariantChange",t),!this.i.variants.find((i=>i.id==t)))return d("Invalid product variant",t),void a(this.h.customApiHost,"invalid_product_variant",{variantId:t});y(this.q,"current-variant-id",t)}}K(){this.H=!0,clearTimeout(this.W),this.W=setTimeout((()=>{this.H=!1}),500)}N(){this.T&&(_(this.T,"change",(t=>{d("_listenForQuantityInputChange change",t.target.value),this.G(t.target.value)})),l(this.T,"value",((t,i)=>{t!==i&&(d("_listenForQuantityInputChange observe",[t,i]),this.G(i))})))}G(t){this.Z||(this.h.keepQuantityInput&&!this.H?this.h.keepQuantityInput&&y(this.q,"quantity",t):this.X&&this.X.length&&this.k(this.X))}k(t){if(!this.T)return;this.Z=!0;let i=t.reduce(((t,i)=>t+i.quantity),0);if(this.h.addDifferentVariantsToCartSeparately){const n=this.V.currentVariantId();i=(t.find((({variantId:t})=>t==n))||t[0]).quantity}d("_updateQuantityInput",i),this.T.value=i,this.T.dispatchEvent(new Event("change",{bubbles:!0})),setTimeout((()=>{this.Z=!1}),100)}D(){this.h.useDiscountCodes&&_(this.q,"deal-bar-selected",(t=>{const{dealBarId:i}=t.detail,n=this.P.discountCodes.find((t=>t.dealBarId==i));d("listenForDealBarSelect",[i,n]),this.Y=n&&n.code}))}M(){this.S&&_(this.q,"variant-selected",(t=>{const{variantId:i}=t.detail,n=this.i.variants.find((t=>t.id==i));if(d("listenForBlockVariantSelect",[i,n]),n.imageId&&n.imageId!=this.tt){this.tt=n.imageId,this.K();for(const[t,i]of n.options.entries()){const s=this.i.options[t].name;this.S.select(t+1,s,i,n.id)}}}))}R(){_(this.q,"variants-changed",(t=>{clearTimeout(this.updateQuantityInputTimeoutHandle);const{variantIdQuantities:i,formattedPrice:n,preselected:s}=t.detail;d("listenForBlockVariantsChange",t.detail),this.K(),this.V.update(i),this.X=i,this.k(i),this.I.updatePrice(n),this.it(),s&&(this.updateQuantityInputTimeoutHandle=setTimeout((()=>this.k(i)),1e3))}))}J(){this.I.onClickIfConditionMet((()=>(setTimeout((()=>{this.T&&this.X&&1===this.X.length&&this.X[0].quantity!=Number(this.T.value)&&a(this.h.customApiHost,"invalid_quantity_input_value_v4",{deal_bar_quantity:this.X[0].quantity,input_value:Number(this.T.value)})}),10),!!this.Y||(!!this.P.skipCart||(!!this.nt()||!!this.X&&!(this.X.length<2))))),(async()=>this.Y?(await this.st(),this.ot(this.Y)):this.P.skipCart?(await this.st(),void(window.location.href=q("checkout"))):this.nt()?this.st():this.et()),(()=>!!this.Y||this.P.skipCart||this.nt()))}nt(){return!!p("#UpcartPopup")}async et(){d("addVariantsExceptCurrentToCart",this.X);const t=this.V.currentVariantId(),i=this.X.filter((({variantId:i})=>i!=t))||this.X[0];await this.rt(i)}async st(){d("addAllVariantsToCart",this.X);let t=this.X;t||=[{variantId:this.V.currentVariantId(),quantity:1}],await this.rt(t)}ct(){const t=[...document.querySelectorAll('[name^="properties"]')].map((t=>[t.name.match(/properties\[(.*)\]/)[1],t.value]));return Object.fromEntries(t)}async rt(t){const i=this.ct(),n={items:t.map((({variantId:t,quantity:n})=>({id:t,quantity:n,properties:i})))};d("makeAddToCartRequest",n),await fetch(q("cart/add.js"),{method:"POST",body:JSON.stringify(n),headers:{"Content-Type":"application/json"}})}async ot(t){const i=q(`discount/${t}`);await fetch(i,{credentials:"include"}),window.location.href=q(`cart?discount_code=${t}`)}L(){_(this.I.element,"click",(t=>{this.ut=!0,d("Add to cart button click event (legacy)",t),this.dt(t)})),_(this.t,"submit",(t=>{this.ut||a(this.h.customApiHost,"form_submitted_without_add_to_cart_click"),d("Add to cart form submit event (legacy)",t),this.dt(t)}))}async dt(t){if(d("legacyHandleCartSubmit",this.X),this.Y)return this.ht(t);this.h.multivariantCartDrawer||this.X&&(this.X.length<2||(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),await this.lt(),T.location.href=q("cart")))}async ht(t){d("legacyHandleCartSubmitWithDiscountCode",this.Y),t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),await this.lt(),await this.ot(this.Y)}async lt(){const t=this.V.legacyFormData();if(this.h.useLineItemProperties)for(const[i,n]of this.ft())t.set(i,n);d("legacyMakeAddToCartRequest",t);const i=await fetch(q("cart/add.js"),{method:"POST",body:t});return await i.json()}ft(){if(!this.X||this.X.length<2)return[];const t=[],i=[...document.querySelectorAll('[name^="properties"]')].map((t=>[t.name.match(/properties\[(.*)\]/)[1],t.value]));for(const[n]of this.X.entries())for(const[s,o]of i)t.push([`items[${n}][properties][${s}]`,o]);return t}it(){if(!this.X)return;const t="kaching-bundles-form--different-variants-selected";this.X.length>1?this.t.classList.add(t):this.t.classList.remove(t)}};class P{static find(t){let i=t.parentElement;for(;i;){if("227741.myshopify.com"===window.Shopify.shop){const t=i.querySelectorAll(".swatch.clearfix");if(t.length)return new P(t)}const t=i.querySelector('variant-selects, variant-radios, variant-picker, product-variants, gp-product-variants, [data-pf-type="ProductVariantSwatches"]');if(t)return new P([t]);const n=[...i.querySelectorAll(".selector-wrapper, .radio-wrapper, .variant-wrapper")];if(n.length){const t=n.filter((t=>!n.some((i=>i!==t&&i.contains(t)))));return new P(t)}i=i.parentElement}}constructor(t){this._t=[...t]}hide(){for(const t of this._t)t.style.display="none"}select(t,i,n,s){if(d("VariantPicker#select",[t,i,n]),"227741.myshopify.com"===window.Shopify.shop)return this.yt(t,i,n);this.bt(t,i,n)||this.wt(t,i,n)||this.gt(s)}bt(t,i,n){const s=this._t.map((t=>[...t.querySelectorAll("input")])).flat().filter((n=>[i,`option${t}`].includes(n.name))).find((t=>t.value==n));return!!s&&(s.click(),!0)}wt(t,i,n){const s=this._t.map((t=>[...t.querySelectorAll("select")])).flat().find((n=>!![`options[${i}]`,`option${t}`].includes(n.name)||(n.dataset.index===`option${t}`||(n.dataset.optionName===i||n.id===`p-variant-dropdown-${t}`))));if(!s)return!1;return!![...s.options].find((t=>t.value==n))&&(s.value=n,s.dispatchEvent(new Event("change",{bubbles:!0})),!0)}gt(t){const i=this._t.map((t=>[...t.querySelectorAll("select")])).flat().find((i=>[...i.options].find((i=>i.value==t))));return!!i&&(i.value=t,i.dispatchEvent(new Event("change",{bubbles:!0})),!0)}yt(t,i,n){for(let i of this.kt){const s=[...i.querySelectorAll("input")].filter((i=>"option-"+(t-1)===i.name)).find((t=>t.value==n));if(s)return s.click(),!0}}}const F=P;const V=class{constructor(t){this.element=t}onClickIfConditionMet(t,i,n){this.element.addEventListener("click",(async s=>{const o=t(),e=n();d("AddToCartButton#interceptClick",{conditionMet:o,preventDefault:e,submitInProgress:this.vt,ignoreClick:this.Ct}),o&&(this.vt?this.vt=!1:this.Ct||(this.vt=!0,this.Ct=!0,this.element.disabled=!0,setTimeout((()=>{this.Ct=!1}),1e3),s.preventDefault(),s.stopPropagation(),s.stopImmediatePropagation(),await i(),this.element.disabled=!1,e?this.vt=!1:this.element.click()))}),!0)}updatePrice(t){const i=this.qt(this.element);i&&(i.innerHTML=t)}qt(t){if(!t.childNodes.length)return null;const i=t.childNodes[0].nodeValue;if(i&&i.match(/\d/)&&!i.match(/[a-zA-Z]{4}/))return t;for(const i of t.childNodes){const t=this.qt(i);if(t)return t}return null}},A="kachingappz-bundles.herokuapp.com",$=async(t,i,n,s,o)=>{const e=`https://${t||A}/storefront_api/products?shop=${i}&country=${n}&language=${s}&ids=${o.join(",")}`,r=await fetch(e);return(await r.json()).products},B=async(t,i)=>{const n=`https://${t||A}/storefront_api/deal_blocks?shop=${i}`,s=await fetch(n);return(await s.json()).deal_blocks},O=['[data-pf-type^="ProductATC"]',"button.gp-button-atc","gp-product-button button",'button[type="submit"]','input[type="submit"]',"button"],j='form[action*="/cart/add"]',N=t=>{"visualPreviewInitialLoad"!==new URLSearchParams(window.location.search).get("source")&&(console.log('%c❗ [Kaching Bundles] Please add "Add to cart" button to the page template',"color: white; font-weight: bold; background: linear-gradient(90deg, #8181d7, #93e9e5); padding: 5px 8px; border-radius: 3px;"),a(t.customApiHost,"missing_add_to_cart_button"))};class D{constructor(t,i,n,s){this.h=i,t.innerHTML='<kaching-bundles-block class="kaching-bundles"></kaching-bundles-block>',b(t).initialized=!0,this.q=p("kaching-bundles-block",t),this.t=this.It();const o=this.Tt();o||N(this.h);const e=o&&new V(o),r=this.St(),a=F.find(this.q);a&&n.hideVariantPicker&&a.hide(),this.Pt(),new S(this.q,this.t,e,r,a,i,n,s)}It(){let t=this.q.parentElement;for(;t;){for(const i of O){const n=p(`${j} ${i}`,t);if(n)return n.closest(j)}t=t.parentElement}return null}Tt(){if(this.t){if("njinked.myshopify.com"===window.Shopify.shop){const t=[];for(const i of O){const n=this.t.querySelectorAll(i);t.push(...n)}return v(this.q,t)}for(const t of O){const i=p(t,this.t);if(i)return i}}}St(){const t=this.Ft(),i=v(this.q,t,6);if(!i)return;this.h.keepQuantityInput||(i.style.display="none");return i.matches("input")?i:i.querySelector("input")}Ft(){const i=((t,i)=>{const{customSelectors:n}=t;if(n)return n[i]})(this.h,"quantity");if(i){const t=f(i);if(t.length)return t}for(const[i,n]of t){if(!n)continue;const t=f(n);if(t.length)return t}return f(".product-form__quantity")}Pt(){setTimeout((()=>{void 0!==window.FastClick&&f("*",this.q).forEach((t=>{return n="needsclick",(i=t)&&i.classList.add(n);var i,n}))}),1e3)}}class E{constructor(t){this.h=t}init(){const t=f("kaching-bundle, kaching-bundle-deals");this.Vt(t),0===t.length&&this.At(),this.$t()}Vt(t){const i=w("script#kaching-bundles-product");if(i)for(const n of t)n.getAttribute("product-id")||n.setAttribute("product-id",i.id)}At(){if(!w("script#kaching-bundles-deal-block-config"))return;const t=this.Bt();if(!t.length)return void N(this.h);const i=w("script#kaching-bundles-product"),n=i&&i.id||this.h.productId;for(const i of t){const t=m("kaching-bundle");t.setAttribute("product-id",n),i.parentElement.insertBefore(t,i)}}async $t(){const t=[...f("kaching-bundle, kaching-bundle-deals")].filter((t=>t.getAttribute("product-id")));d("_initializePlaceholders",t);if(0===t.filter((t=>!b(t).initialized)).length)return;const i=await this.Ot(t);for(const n of t){const t=n.getAttribute("product-id"),{product:s,dealBlock:o}=i.get(t);s&&o&&new D(n,this.h,o,s)}}async Ot(t){const i=t.map((t=>t.getAttribute("product-id"))),n=[...f("script#kaching-bundles-product")],s=new Map(n.map((t=>[b(t).productId,JSON.parse(t.textContent)]))),o=i.filter((t=>!s.has(t))),e=[...f("script#kaching-bundles-deal-block-config")],r=new Map(e.map((t=>[b(t).productId,JSON.parse(t.textContent)]))),a=i.filter((t=>!r.has(t))),[c,u]=await Promise.all([o.length>0?$(this.h.customApiHost,this.h.shopifyDomain,window.Shopify.country,window.Shopify.locale.toUpperCase(),o):[],a.length>0?B(this.h.customApiHost,this.h.shopifyDomain):[]]),d=new Map(o.map((t=>[t,c.find((i=>i.id==t))]))),h=new Map([...s,...d]),l=new Map(a.map((t=>[t,this.jt(u,h.get(t))]))),p=new Map([...r,...l]);return new Map(i.map((t=>[t,{product:h.get(t),dealBlock:p.get(t)}])))}jt(t,i){const n=t.filter((t=>"selected-products"===t.blockVisibility)).find((t=>t.selectedProductIds.includes(String(i.id))));if(n)return n;const s=t.filter((t=>"selected-collections"===t.blockVisibility)).find((t=>i.collectionIds.some((i=>t.selectedCollectionIds.includes(String(i))))));if(s)return s;const o=t.filter((t=>"excluded-products"===t.blockVisibility)).find((t=>!t.excludedProductIds.includes(String(i.id))));return o||t.find((t=>"all-products"===t.blockVisibility))}Bt(){const t=this.Nt();if(t)return[t];const i=this.Dt();return i?[i]:[]}Nt(){for(const i of t){const t=p(i[0]);if(t)return t}}Dt(){for(const t of O){const i=p(`${j} ${t}`);if(i)return i.parentElement}return null}}const M=t=>new E(t).init();(()=>{if(void 0===n&&(n="off"===i()),n){const t=document.querySelectorAll("style#kaching-bundles-custom-css");for(const i of t)i.remove();return}o()&&(d("App version",C()),d("Shopify domain",window.Shopify.shop));const t=w("script#kaching-bundles-config");if(!t)return;u(t.customApiHost);const s=window.Shopify.currency;if(t.currencyRate=s?Number(s.rate):1,M(t),window.Shopify.designMode&&_(window,"shopify:section:load",(()=>{M(t)})),"6f301b.myshopify.com"===window.Shopify.shop){new MutationObserver((i=>{for(const n of i)if(n.addedNodes.length)for(const i of n.addedNodes)if(i.nodeType===Node.ELEMENT_NODE&&("KACHING-BUNDLE"===i.tagName||i.querySelector("kaching-bundle")))return d("<kaching-bundle> tag added"),void M(t)})).observe(document,{childList:!0,subtree:!0})}})()})();